const CACHE_NAME="BLOGCACHE",npm_name="aloejun",default_version="2022.9.5";let cachelist=["/offline.html","/css/main.css","/js/main.js"];self.CACHE_NAME="SWHelperCache",self.db={read:(n,e)=>new Promise((t,e)=>{caches.open(CACHE_NAME).then(e=>{e.match(new Request("https://LOCALCACHE/"+encodeURIComponent(n))).then(function(e){e||t(null),e.text().then(e=>t(e))}).catch(()=>{t(null)})})}),write:(n,s)=>new Promise((t,e)=>{caches.open(CACHE_NAME).then(function(e){e.put(new Request("https://LOCALCACHE/"+encodeURIComponent(n)),new Response(s)),t()}).catch(()=>{e()})})},self.addEventListener("install",async function(e){self.skipWaiting(),e.waitUntil(caches.open(CACHE_NAME).then(function(e){return e.addAll(cachelist)}))}),self.addEventListener("fetch",async t=>{try{t.respondWith(handle(t.request))}catch(e){t.respondWith(handleerr(t.request,e))}});const handleerr=async(e,t)=>new Response(`<h1>Service Worker 遇到致命错误</h1>
    <b>${t}</b>`,{headers:{"content-type":"text/html; charset=utf-8"}});let cdn={gh:{jsdelivr:{url:"https://cdn.jsdelivr.net/gh"},yfan:{url:"https://jsd.cky.codes/gh"},jsdelivr_fastly:{url:"https://fastly.jsdelivr.net/gh"},jsdelivr_gcore:{url:"https://gcore.jsdelivr.net/gh"},pigax_jsd:{url:"https://u.pigax.cn/gh"},pigax_chenyfan_jsd:{url:"https://cdn-jsd.pigax.cn/gh"},tianli:{url:"https://cdn1.tianli0.top/gh"},aloejun:{url:"https://static.islu.cn"}},combine:{jsdelivr:{url:"https://cdn.jsdelivr.net/combine"},yfun:{url:"https://jsd.cky.codes/combine"},jsdelivr_fastly:{url:"https://fastly.jsdelivr.net/combine"},jsdelivr_gcore:{url:"https://gcore.jsdelivr.net/combine"},pigax_jsd:{url:"https://u.pigax.cn/combine"},pigax_chenyfan_jsd:{url:"https://cdn-jsd.pigax.cn/combine"},tianli:{url:"https://cdn1.tianli0.top/combine"}},npm:{eleme:{url:"https://npm.elemecdn.com"},jsdelivr:{url:"https://cdn.jsdelivr.net/npm"},yfun:{url:"https://jsd.cky.codes/npm"},zhimg:{url:"https://unpkg.zhimg.com"},unpkg:{url:"https://unpkg.com"},bdstatic:{url:"https://code.bdstatic.com/npm"},pigax_jsd:{url:"https://u.pigax.cn/npm"},pigax_unpkg:{url:"https://unpkg.pigax.cn/"},pigax_chenyfan_jsd:{url:"https://cdn-jsd.pigax.cn/npm"},tianli:{url:"https://cdn1.tianli0.top/npm"}}};const lfetch=async(e,t,s)=>{let r=new AbortController;const c=async e=>new Response(await e.arrayBuffer(),{status:e.status,headers:e.headers});return Promise.any||(Promise.any=function(e){return new Promise((t,n)=>{let s=(e=Array.isArray(e)?e:[]).length,r=[];if(0===s)return n(new AggregateError("All promises were rejected"));e.forEach(e=>{e.then(e=>{t(e)},e=>{s--,r.push(e),0===s&&n(new AggregateError(r))})})})}),Promise.any(e.map(e=>((s=s||{}).signal=r.signal,new Promise((t,n)=>{fetch(e,s).then(c).then(e=>{200==e.status?(r.abort(),t(e)):n(null)}).catch(e=>{(String(e).match("The user aborted a request")||String(e).match("Failed to fetch"))&&console.log(),n(null)})}))))},mirror=[`https://registry.npmmirror.com/${npm_name}/latest`,`https://registry.npmjs.org/${npm_name}/latest`],set_newest_version=async e=>(console.log("[LOG] 开始检查更新."),lfetch(e,e[0]).then(e=>e.json()).then(async e=>{await db.read("blog_version")!=e.version&&console.info("[INFO] 当前版本: "+await db.read("blog_version")+"最新版本:"+e.version),await db.write("blog_version",e.version)})),handle=(setInterval(async()=>{await set_newest_version(mirror)},6e4),setTimeout(async()=>{await set_newest_version(mirror)},5e3),async function(n){const t=n.url;var e,s=new URL(t),r=(s.port,s.hostname),s=s.pathname;let c=[];if("GET"!=n.method||n.url.match(/waline/))return fetch(n);if("GET"==n.method&&("www.islu.cn"==r||"islu.cn"==r||"localhost"==r)){var a=e=>((e=e.split("?")[0].split("#")[0]).match(/\/$/)&&(e+="index"),e.match(/\.[a-zA-Z]+$/)||e.match(/woff2/)||(e+=".html"),e),i=(e,t,n,s)=>{var r,c=0==s?[`https://unpkg.com/${e}@`+t,`https://npm.elemecdn.com/${e}@`+t,`https://cdn.jsdelivr.net/npm/${e}@`+t,`https://cdn1.tianli0.top/npm/${e}@`+t,`https://fastly.jsdelivr.net/npm/${e}@`+t]:[`https://unpkg.com/${e}@`+t,`https://npm.elemecdn.com/${e}@`+t,`https://cdn.jsdelivr.net/npm/${e}@`+t,`https://npm.sourcegcdn.com/${e}@`+t,`https://cdn1.tianli0.top/npm/${e}@`+t,`https://fastly.jsdelivr.net/npm/${e}@`+t];for(r in c)c[r]+=n;return c};if(/\.jpg$|.png$/.test(n.url)&&"/wali"!=s.substring(0,5)){var l=!1;if(l=n.headers.has("accept")?n.headers.get("accept").includes("webp"):l)return l=(l=n.clone()).url.substr(0,l.url.lastIndexOf("."))+".webp",fetch(l,{mode:"no-cors"})}return".html"==a(s).match(/\.[a-zA-Z]+$/)?lfetch(i(""+npm_name,await db.read("blog_version")||""+default_version,a(s),0)).then(e=>e.arrayBuffer()).then(e=>new Response(e,{headers:{"Content-Type":"text/html;charset=utf-8"}})):lfetch(i(""+npm_name,await db.read("blog_version")||""+default_version,a(s),0))}for(e in cdn)for(var h in cdn[e])if(r==cdn[e][h].url.split("https://")[1].split("/")[0]&&t.match(cdn[e][h].url)){for(var o in c=[],cdn[e])c.push(t.replace(cdn[e][h].url,cdn[e][o].url));return-1<t.indexOf("@latest/")?lfetch(c,t):caches.match(n).then(function(e){return e||lfetch(c,t).then(function(t){return caches.open(CACHE_NAME).then(function(e){return e.put(n,t.clone()),t})})})}return fetch(n).then(function(t){if(t)return caches.open(CACHE_NAME).then(function(e){return e.delete(n),e.put(n,t.clone()),t});throw"error"}).catch(function(e){return caches.match(n).then(function(e){return e||caches.match(new Request("/offline.html"))})})});